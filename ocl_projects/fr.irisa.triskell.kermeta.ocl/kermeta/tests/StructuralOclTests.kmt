/* $Id: StructuralOclTests.kmt,v 1.10 2007-12-07 04:55:50 ffleurey Exp $
 * Creation date: March 6, 2007
 * License:
 * Copyright:
 * Authors:
 */
 
@mainClass "oclTests::StructuralOclTests"
@mainOperation "main"

package oclTests;

require kermeta

require "../transformations-dev/ocl2kmtVisitor.kmt" 
require "../helpers/OCLHelper.kmt" 
     
using kermeta::kunit
using kermeta::standard
using kermeta::persistence
using ocl2kmt

class  StructuralOclTests  inherits TestCase
{
    attribute repository: EMFRepository
    attribute helper : OCLHelpers::OCLHelper
    attribute visitor :Ocl2kmtVisitor 
    attribute parsedOCL : Set<Object> 
    attribute ecoreFile: String
	//attribute de : DynamicExpression 

				    
	method setUp() is
		do
			repository := EMFRepository.new        
            helper := OCLHelpers::OCLHelper.new
            visitor := Ocl2kmtVisitor.new
            ecoreFile := "platform:/plugin/fr.irisa.triskell.kermeta.ocl/ocl/company.ecore"

	    	
			//de := DynamicExpression.new
			//de.initializeDefaults
		end
		
	 operation visitOclXmi(filename: String): String is
        do
             var sourceFileName : String init "platform:/plugin/fr.irisa.triskell.kermeta.ocl/model/" + filename + ".xmi"
            var io : StringWriter init StringWriter.new
            visitor.setIo(io)
            visitor.setEcoreHelper(EcoreHelpers::EcoreHelper.new.loadMetamodel(ecoreFile))
            parsedOCL  := helper.loadOCLModel(repository, sourceFileName)
            helper.getPackageDeclaration(parsedOCL).accept(visitor)
            result := io.s
              
	     	 
            
            

    
        end
		
		
	operation test01(): Void is
	// test class @aspect class { ... inv ... } generation
		do
			var kmt : String  init  visitOclXmi("01-booleanLiteralTrue")
			var expected : String init "package sample; require kermeta require \"sample.ecore\" using kermeta::standard @aspect \"true\" class A{ inv invariant1 is do true end } " 
			assertEqual(expected, kmt)
		end
		
	operation test02(): Void is
	// test class @aspect class { operation def } generation
		do
			var kmt : String  init  visitOclXmi("definition")
			assertEqual("package sample @aspect \"true\" class A{ operation test():Boolean is do result := true end} ", kmt)
		end

	operation test03(): Void is
	// test pre and post generation
		do
			var kmt : String  init  visitOclXmi("preAndPost")
			assertEqual("package sample @aspect \"true\" class Y{ @overloadable \"true\" operation getB(a : Integer, b:Boolean):B pre pre1 is do a.isGreater(0) end pre pre2 is do true end post post3 is do ~result.equals(self.ab) end is do var e: Exception init NotImplementedException.new e.message := \"OCL pre/post/body: Y.foo\" raise e end } ", kmt)
		end
		
	operation main() : Void is 
	  do 
			var testRunner : TestRunner init TestRunner.new
			var suite : TestSuite init TestSuite.new.addAllTestCasesFrom(StructuralOclTests)
			testRunner.runTest(suite)
			testRunner.printTestResult
  	end
}
