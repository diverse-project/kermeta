/**
 * @generated by Gymnast from kermeta.ast on 8 juil. 2008 12:04:11
 */

package fr.irisa.triskell.kermeta.parser.gen.parser;

import java.io.Reader;

import antlr.MismatchedCharException;
import antlr.MismatchedTokenException;
import antlr.NoViableAltException;
import antlr.NoViableAltForCharException;
import antlr.RecognitionException;
import antlr.TokenStreamRecognitionException;

import fr.irisa.triskell.kermeta.parser.gen.ast.*;
import org.eclipse.gymnast.runtime.core.parser.*;

public class KermetaParserDriver implements IParser {

    public ParseContext parse(Reader input) {
    	KermetaLexer lexer = new KermetaLexer(input);
		lexer.setColumn(0);
		lexer.setTabSize(1);
		
		KermetaParser parser = new KermetaParser(lexer);
		ParseContext parseContext = new ParseContext();
		parser.setParseContext(parseContext);
		
		parseCompUnit(parser, parseContext);
	
		if (parseContext.getMessageCount() == 0) {
			System.out.println("Parse OK!");
		}
		else {
			ParseMessage[] msgs = parseContext.getMessages();
			for (int i = 0; i < msgs.length; i++) {
				System.err.println(msgs[i].getMessage());
			}
		}
		
		return parseContext;
    }

	private void parseCompUnit(KermetaParser parser, ParseContext parseContext) {
	    try {
	        CompUnit compUnit = parser.compUnit();
	        parseContext.setParseRoot(compUnit);
	    }
	    catch (RecognitionException rex) {
	        parseContext.addParseMessage(createParseError(rex));
	    }
	    catch (TokenStreamRecognitionException tex) {
	    	RecognitionException rex = tex.recog;
	        parseContext.addParseMessage(createParseError(rex));
	    }
	    catch (Exception ex) {
	        parseContext.addParseMessage(new ParseError(ex.getMessage(), 1));
	    }
	}

	static ParseError createParseError(RecognitionException ex) {
		String message = ex.getMessage();
		int offset = ex.getColumn();
		int length = 0;

		if (ex instanceof MismatchedCharException) {
			length = 1;
		} else if (ex instanceof MismatchedTokenException) {
			MismatchedTokenException ex2 = (MismatchedTokenException) ex;
			if ((ex2.token != null) && (ex2.token.getText() != null)) {
				length = ex2.token.getText().length();
			}
		} else if (ex instanceof NoViableAltException) {
			NoViableAltException ex2 = (NoViableAltException) ex;
			if ((ex2.token != null) && (ex2.token.getText() != null)) {
				length = ex2.token.getText().length();
			}
		} else if (ex instanceof NoViableAltForCharException) {
			length = 1;
		}
		
		return new ParseError(message, offset, length);
	}

}