/* $Id: 056_load_and_save_in_another_location.main.kmt,v 1.3 2007-04-04 13:51:43 ftanguy Exp $
 * Creation date: November 14, 2006
 * License:
 * Copyright:
 * Authors:
 */
@mainClass "load_and_save_in_another_location::Main"
@mainOperation "main"


package load_and_save_in_another_location;

require kermeta
require "platform:/plugin/fr.irisa.triskell.kermeta/lib/ecore.kmt"
require "platform:/resource/fr.irisa.triskell.kermeta.interpreter/test/emf_testcases/metamodels/056_test_MdlSave.ecore"

using kermeta::kunit
using kermeta::standard
using kermeta::persistence
using tester


class Main inherits kermeta::kunit::TestCase
{

	operation main () : Void is do
		
		var tr : TestRunner init TestRunner.new
		
		tr.run(Main)
		tr.printTestResult
		/*
		var testClass : Main init Main.new
		testClass.setUp
		//testClass.testLoadSaveEcoreFileUsingAnotherResource 
		testClass.testLoadSaveFileUsingAnotherResource */
		stdio.writeln("--- load_and_save_in_another_location END ---")
	end
	
	attribute ecoreMetamodel : String
	reference repository : EMFRepository
	operation setUp() : Void is do
		
    	ecoreMetamodel := "platform:/resource/fr.irisa.triskell.kermeta.interpreter/test/emf_testcases/instances/Ecore.ecore"
    	repository := EMFRepository.new
	end
	
	/** 
	 * load and save in another location just reusing the same resource but using the SaveAsNewURI function
	 */
    operation testLoadSaveEcoreFileUsingSaveAsNewURI() : Void is do 
		var repository : EMFRepository init EMFRepository.new
		stdio.writeln(repository.toString)
		
		stdio.writeln(1.toString)
		
		// load
		var resource : Resource init repository.createResource("platform:/resource/fr.irisa.triskell.kermeta.interpreter/test/emf_testcases/instances/fsm.ecore" , ecoreMetamodel)
    	resource.load
    	stdio.writeln(resource.toString)
      	stdio.writeln(resource.instances.toString)
      	stdio.writeln(resource.instances.size.toString)
    	var nbInstances : Integer init resource.instances.size
    	stdio.writeln("avant assert")
    	assertTrueWithMsg(nbInstances >= 1, "testLoadSaveEcoreFileUsingSaveAsNewURI didn't find at least one element in the model")
        
        stdio.writeln("avant le load")
        
		// save
	    resource.saveWithNewURI("platform:/resource/fr.irisa.triskell.kermeta.interpreter/test/emf_testcases/instances/out/fsm.testLoadSaveEcoreFileUsingSaveAsNewURI.ecore")
	    // check the saved file
	    checkEcoreSavedFile("platform:/resource/fr.irisa.triskell.kermeta.interpreter/test/emf_testcases/instances/out/fsm.testLoadSaveEcoreFileUsingSaveAsNewURI.ecore",
	    					nbInstances,
	    					"testLoadSaveEcoreFileUsingSaveAsNewURI")
    end
    
    
	/*
	 * load and save in another location just reusing the same resource but changing the URI of the resource
	 */
   /* operation testLoadSaveEcoreFileChangingTheURI() : Void is do 
		var repository : EMFRepository init EMFRepository.new
		// load
		var resource : Resource init repository.createResource("platform:/resource/fr.irisa.triskell.kermeta.interpreter/test/emf_testcases/instances/fsm.ecore" , ecoreMetamodel)
    	resource.load
    	var nbInstances : Integer init resource.instances.size
    	
    	assertTrueWithMsg(nbInstances >= 1, "testLoadSaveEcoreFileChangingTheURI didn't find at least one element in the model")
        
		// save
	    resource.uri := "platform:/resource/fr.irisa.triskell.kermeta.interpreter/test/emf_testcases/instances/out/fsm.testLoadSaveEcoreFileChangingTheURI.ecore"
	    resource.save
	    // check the saved file
	    checkEcoreSavedFile("platform:/resource/fr.irisa.triskell.kermeta.interpreter/test/emf_testcases/instances/out/fsm.testLoadSaveEcoreFileChangingTheURI.ecore",
	    					nbInstances,
	    					"testLoadSaveEcoreFileChangingTheURI")
    end*/
    
    /*
   	 * load and save in another location by moving the model element to another resource
   	 * bug #2256
	 */
   /* operation testLoadSaveEcoreFileUsingAnotherResource() : Void is do 
    	
		// load
		var resource1 : Resource init repository.createResource("platform:/resource/fr.irisa.triskell.kermeta.interpreter/test/emf_testcases/instances/fsm.ecore" ,
																 ecoreMetamodel)
    	resource1.load
    	
    	// check the number of element in the resource
    	var nbInstances : Integer init resource1.instances.size
    	assertTrueWithMsg(nbInstances >= 1, "testLoadSaveEcoreFileUsingAnotherResource didn't find at least one element in the model")
        
		// save
		var resource2 : Resource init repository.createResource("platform:/resource/fr.irisa.triskell.kermeta.interpreter/test/emf_testcases/instances/out/fsm.testLoadSaveEcoreFileUsingAnotherResource.ecore" , ecoreMetamodel)
		// move model elements from resource1 to resource2
	    resource2.instances.addAll(resource1.instances)
	    resource2.save
	    // check the saved file
	    checkEcoreSavedFile("platform:/resource/fr.irisa.triskell.kermeta.interpreter/test/emf_testcases/instances/out/fsm.testLoadSaveEcoreFileUsingAnotherResource.ecore",
	    	nbInstances,
	    	"testLoadSaveEcoreFileUsingAnotherResource")
    end*/
    
    operation checkEcoreSavedFile(fileName : String, numberOfInstances : Integer, testName : String) : Void is do
    	var resource : Resource init repository.createResource(fileName, ecoreMetamodel)
    	resource.load
    	    	
    	// check the number of element in the resource
    	var nbInstances : Integer init resource.instances.size
    	assertTrueWithMsg(nbInstances == numberOfInstances, testName + " didn't save the expected number of element in the target model")
        
    end
    
    
    /*---------------*/
    /* same test but using another metamodel */
    
   /* operation testLoadSaveFileUsingAnotherResource() is do
		var rep : EMFRepository init EMFRepository.new
		var res1 : EMFResource
		var res2 : EMFResource
		var res3 : EMFResource
        var inputMdlUri : String init "platform:/resource/fr.irisa.triskell.kermeta.interpreter/test/emf_testcases/instances/056_test.xmi"
        var outputMdlUri : String init "platform:/resource/fr.irisa.triskell.kermeta.interpreter/test/emf_testcases/instances/out/056_test.gen.xmi"
        var inputMMdlUri : String init "platform:/resource/fr.irisa.triskell.kermeta.interpreter/test/emf_testcases/metamodels/056_test_MdlSave.ecore"

   		stdio.writeln("Loading model at " + inputMdlUri + " using " + inputMMdlUri)
    	res1 ?= rep.createResource(inputMdlUri, inputMMdlUri)
    	res1.load
    	//stdio.writeln("Model loaded")
    	
    	var root : A
    	root ?= res1.instances.one
    	//stdio.writeln("Get root mdl elt: " + root.toString)
    	
    	//stdio.writeln("Saving model at " + outputMdlUri)
    	res2 ?= rep.createResource(outputMdlUri, inputMMdlUri)
    	res2.instances.add(root)
    	res2.save
    	//stdio.writeln("Model saved")
    	
    	res3 ?= rep.createResource(outputMdlUri, inputMMdlUri)
    	res3.load
    	assertTrueWithMsg(res3.instances.size >=1, "testLoadSaveFileUsingAnotherResource didn't save the expected number of element in the target model")
        
	end*/
 
}


