package kermeta::language::structure;

require kermeta
require "http://www.eclipse.org/emf/2002/Ecore"
require "compile_behavior.kmt"
require "containment_traversable.kmt"
require "trace_structure.kmt"
require "compile_helper.kmt"

using kermeta::language::structure
using kermeta::language::behavior
using kermeta::standard
using kermeta::utils
using ecore
using compile::helper

aspect class Object {
	operation compile(context : Integer) : String is do
		result := ""
		//stdio.writeln("F7-1: " + self.name)
	end
}

aspect class Package {
	method compile(context : Integer) : String is do
		result := ""
		// Creating the associated ecore package
		var ecorePackage : EPackage init EPackage.new
		ecorePackage.name := self.name
		ecorePackage.nsURI := self.uri
		// Setting the ecore proxy
		self.ecoreProxy := ecorePackage
		// Compile the owned elements
		self.eachOwnedElement{ cd | cd.compile(context) }
	end
}
 
aspect class ClassDefinition {
	method compile(context : Integer) : String is do
		result := ""
		// Creating the associated ecore class
		var ecoreClass : EClass init EClass.new
		ecoreClass.interface := false
		ecoreClass.name := self.name
		ecoreClass.~abstract := self.isAbstract
		
		var p : Package
		p ?= self.container()
		p.ecoreProxy.eClassifiers.add(ecoreClass)
		
		// Setting the ecore proxy
		self.ecoreProxy := ecoreClass
		// Compile the owned elements
		//self.eachOwnedElement{ o | o.compile(context) }
	end
	
}

aspect class PrimitiveType {
	method compile(context : Integer) : String is do
		result := ""
		//stdio.writeln("F2-2: " + self.name)
	end
}

aspect class MultiplicityElement {
	method compile(context : Integer) : String is do
		result := ""
		//stdio.writeln("F2-311111: " + self.name)
	end
}
  
aspect class Property {
	method compile(context : Integer) : String is do
		result := ""
		// Set the traceability
	end 
}

aspect class Operation {
	method compile(context : Integer) : String is do
		result := ""
		// Set the traceability
		self.ecoreProxy := CompileHelper.new.findEOperationProxy( self )
		
		var javaCode : StringBuffer init StringBuffer.new
		
		if (self.body != void) then
		
			var type : String init self.type.asType(Type).compile(context)
			if ( type!="Void" and type!="void" ) then
				javaCode.append("\n" + type + " result = null;\n")
			end
			 
			// The Java source code is provided by: self.body.compile(context)
			javaCode.append(self.body.compile(context))
			
			if ( type!="Void" and type!="void" ) then
				javaCode.append("\nreturn result;\n")
			end
		end
		
		// Finally add the EAnnotation containing the Java code in the Ecore model
        CompileHelper.new.addAnnotationGenModelImpl(self.ecoreProxy, javaCode.toString)
	end
}

aspect class Type {
	method compile(context : Integer) : String is do
		result := ""
		
		/*if (self.isInstanceOf(PrimitiveType)) then
			var pt : kermeta::language::structure::PrimitiveType
			pt ?= self
			result := pt.instanceType.compile(context)
		else
			result := self.toString
		end*/
	end
}