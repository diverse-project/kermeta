/* $Id: test0.kmt,v 1.1 2008-10-13 20:12:05 fmunoz Exp $ 
 * Creation : August 14, 2008
 * Licence  : EPL 
 * Copyright:
 * Authors  : 
 *            freddy
 */
@mainClass "tests::one::Main"
@mainOperation "main"

@uri "http://www.kermeta.org/decompose/rcd/test/uno"
package tests::one;

require kermeta
require "platform:/resource/fr.irisa.triskell.decompose.test/tests/Rcd.kmt"
require "platform:/resource/fr.irisa.triskell.decompose/src/kermeta/kompose_input.kmt"
require "platform:/resource/fr.irisa.triskell.decompose/src/kermeta/kompose_km_script.kmt"
require "platform:/resource/fr.irisa.triskell.decompose/src/kermeta/OracleSupport.kmt"
require "platform:/resource/fr.irisa.triskell.decompose/src/kermeta/kompose_km_all.kmt"
require "platform:/resource/fr.irisa.triskell.decompose/src/kermeta/oracle_runner.kmt"

using kermeta::standard
using kompose
using rcd
using decomposition
using kermeta::utils
using kermeta::io
using kermeta::persistence
using decomposition::oracle

class Main
{
	attribute counter:Integer 
	attribute mean:Integer
	operation main() :Void is do
		counter:=0
		mean:=1
		mainb(11)		
	end
	
	operation mainb(idx:Integer) : Void is do 
		var toLoad:String toLoad:="platform:/resource/fr.irisa.triskell.decompose.test/tests/rcd/instances/instance"+idx.toString+".xmi"
		var toSaveLeft:String toSaveLeft:="platform:/resource/fr.irisa.triskell.decompose.test/tests/rcd/tests/test"+idx.toString+"/left"
		var toSaveRight:String toSaveRight:="platform:/resource/fr.irisa.triskell.decompose.test/tests/rcd/tests/test"+idx.toString+"/right"
		var toSaveComposition:String toSaveComposition:="platform:/resource/fr.irisa.triskell.decompose.test/tests/rcd/tests/test"+idx.toString+"/result"
		var extentionToSave:String extentionToSave:=".xmi"
		var decomposer:EcoreDecomposer init EcoreDecomposer.new
		
		var imetamodel:String init "http://www.kermeta.org/rcd"
		
		var planDest:String init "platform:/resource/fr.irisa.triskell.decompose.test/tests/rcd/tests/test"+idx.toString+"/plan.xmi"
		
		var inputGenerator:KomposeEcoreFileBridge init KomposeEcoreFileBridge.new
		var scriptGenerator:KomposeScriptBridge init KomposeScriptBridge.new
		var oracleSupport:OSupport init OSupport.new
		var scriptAllGen:KomposeScriptAll init KomposeScriptAll.new
		var oracleGenerator:OracleRunnerScript init OracleRunnerScript.new
		
		var kompose_files:String kompose_files:="platform:/resource/fr.irisa.triskell.decompose.test/tests/rcd/tests/test"+idx.toString+"/komposeComp.kompose"
		var kompose_scripts:String kompose_scripts:="platform:/resource/fr.irisa.triskell.decompose.test/tests/rcd/tests/test"+idx.toString+"/scripts/komposelr_test"
		var kompose_scripts_ext:String kompose_scripts_ext:=".kmt"
		var kompose_oracle_script:String init "platform:/resource/fr.irisa.triskell.decompose.test/tests/rcd/tests/test"+idx.toString+"/scripts/oracleAll.kmt"
		
		var kompose_cmpScript:String init "platform:/resource/org.kermeta.kompose.specialization.rcd/kermeta/Rcd.kmt"
		
		var kompose_cmpScriptMain:String init "rcd"
		
		var oriModel:Mergeable oriModel:=decomposer.loadModel(toLoad)
		
		// load the dependences table
		
		
		// EReference -> EClass
		// EAttribute -> EDataType
		
		 oracleSupport.initialize()
		//set the model of origin
		decomposer.initialize(oriModel)
	//	decomposer.dependants.add("EStructuralFeature")
		decomposer.dependants.add("Attribute")
		decomposer.dependants.add("Association")
	//	decomposer.dependants.add("Class")
	//	decomposer.dependants.add("DataType")
		
		//start the random decomposition
		decomposer.start()
		//save the decomposition result
		
		var lefts:OrderedSet<String> init OrderedSet<String>.new
		var rights:OrderedSet<String> init OrderedSet<String>.new
		
		var numeral:Integer init 0
		if decomposer.left !=void then
			decomposer.left.each{l|
				var file:String file:=toSaveLeft+numeral.toString+extentionToSave
				lefts.add(file)
				decomposer.saveModel(l,file)
				numeral:=numeral+1
				counter:=counter+1
			}
		end
		stdio.writeln("left size: "+lefts.size.toString)
		numeral:=0
		if decomposer.right !=void then
			decomposer.right.each{r|
				var file:String file:=toSaveRight+numeral.toString+extentionToSave
				rights.add(file)
				decomposer.saveModel(r,file)
				numeral:=numeral+1
			}
		end
		
		decomposer.savePlan(planDest)
		stdio.writeln("generating scripts")
		
		var allScripts:OrderedSet<String> init OrderedSet<String>.new
		var fileio:FileIO init FileIO.new
		numeral:=0
		lefts.each{l|
			
			var r:String init rights.at(numeral)
			var resultFile:String init 	toSaveComposition+numeral.toString+extentionToSave
			
			
			
			var thisFile:String init  kompose_files+numeral.toString
			var scriptFile:String init kompose_scripts+numeral.toString+kompose_scripts_ext
			var inputStr:String init inputGenerator.generate(l,r,resultFile)
			var scriptStr:String init scriptGenerator.generate(numeral,thisFile,kompose_cmpScript,kompose_cmpScriptMain,idx)
			allScripts.add(scriptFile)
			
			oracleSupport.sourceMapper.put(resultFile,toLoad)
			
			var matchFile:String init resultFile+".match"
			var diffFile:String init resultFile+".diff"
			
			oracleSupport.matchResultMapper.put(resultFile,matchFile)
			oracleSupport.diffResultMapper.put(resultFile,diffFile)
			
			
			fileio.writeTextFile(thisFile,inputStr)
			fileio.writeTextFile(scriptFile,scriptStr)
			
			numeral:=numeral+1
		}
		
		var allScriptScr:String init scriptAllGen.generate(allScripts,numeral,idx)
		var allScrFile:String init kompose_scripts+"all"+kompose_scripts_ext
		fileio.writeTextFile(allScrFile,allScriptScr)
		
		oracleSupport.resultFile:=toSaveComposition+".ocompare"
		oracleSupport.doSave()
		
		var oracleScript:String init oracleGenerator.generate(oracleSupport.resultFile,imetamodel,kompose_cmpScriptMain,idx)
		fileio.writeTextFile(kompose_oracle_script,oracleScript)
	end
}