<project name="full_kermeta_studio_updatesite" default="all">
	<!-- configuration properties -->		
	<!-- project configuration -->
	<property environment="env"/>

	<property name="env.WORKSPACE" location="."/>
	
	<property name="updatesite.repository" location="${env.WORKSPACE}/target/updatesite"/>
	<property name="category.definition" location="./src/resources/site.xml"/>
	<property name="source.features.and.bundles" location="${env.WORKSPACE}/target/features_and_bundles"/>	
	<property name="source.features" location="${source.features.and.bundles}/features"/>
	<property name="source.bundles" location="${source.features.and.bundles}/plugins"/>
	
	<property name="studio.base.dir" location="${env.WORKSPACE}/target/studiobase/"/>
	<property name="studio.archive.extension" value="tar.gz"/>
	<property name="studio.eclipse.code.name" value="indigo"/>
	<property name="studio.os.variant" value="linux_x86_64"/>
	<property name="studio.base.url" value="http://tipimouss.irisa.fr:8090/job/provision_eclipse_${studio.eclipse.code.name}_bases_for_kermeta/lastSuccessfulBuild/artifact/provision_eclipse_${studio.eclipse.code.name}_bases_for_kermeta/build/kermeta_${studio.eclipse.code.name}_${studio.os.variant}_base.${studio.archive.extension}"/>
	<property name="eclipse.bin.home" location="${studio.base.dir}/eclipse"/>
	<property name="equinox.jar.filename" value="org.eclipse.equinox.launcher_1.2.0.v20110502.jar"/>
	<property name="deploy.server" value="kermeta.org"/>
	<property name="deploy.user" value="web-kermeta"/>
	<property name="deploy.path" value="/home/users/web-kermeta/www/kermeta.org/htdocs/integration_build/kermeta2/update"/>
	

	<property name="kermeta.maven.repsitory" value="http://maven.irisa.fr/artifactory/repo"/>
	<property name="kermeta.language.version" value="2.0.1-BETA4"/>
	<property name="k1.model.version" value="1.4.0"/>
	<property name="k1.framework.version" value="1.4.3-BETA1"/>
	<property name="k1.compiler.version" value="2.9.0-1"/>
	<property name="triskell.utilities.version" value="0.1.0"/>
	<property name="traceability.version" value="2.0.2-BETA1"/>
	<property name="emftext.commons.version" value="1.0.0"/>
	<property name="scala.version" value="2.9.0-1"/>
	<property name="extra.antlr.version" value="2.7.7"/>
	<property name="extra.antlr.stringtemplate.version" value="3.2.1"/>
	
	<target name="all" depends="clean_result, deploy">
	</target>
	
	<target name="deploy" depends="get_studio_base, publish_features_and_bundles, publish_categories, get_site_template">
		<antcall target="upload" />
	</target>
	
	<target name="clean_result">
			<delete dir="${updatesite.repository}" failonerror="false"/>
			<delete dir="${source.features.and.bundles}" failonerror="false"/>
	</target>
	
	<target name="publish_features_and_bundles" depends="get_repository_source">
		<java jar="${eclipse.bin.home}/plugins/${equinox.jar.filename}"
				           fork="true"
				           failonerror="true"
				           maxmemory="128m"
				           >
					<arg value="-application"/>
					<arg value="org.eclipse.equinox.p2.publisher.FeaturesAndBundlesPublisher"/>
					<arg value="-metadataRepository"/>
					<arg value="file:/${updatesite.repository}"/>
					<arg value="-artifactRepository"/>
					<arg value="file:/${updatesite.repository}"/>
					<arg value="-source"/>
					<arg value="${source.features.and.bundles}"/>
					<arg value="-compress"/>
					<arg value="-publishArtifacts"/>
				</java>	
	</target>
	
	
	<target name="publish_categories" depends="publish_features_and_bundles">
			<java jar="${eclipse.bin.home}/plugins/${equinox.jar.filename}"
					           fork="true"
					           failonerror="true"
					           maxmemory="128m"
					           >
						<arg value="-console"/>
						<arg value="-consolelog "/>
						<arg value="-application"/>
						<arg value="org.eclipse.equinox.p2.publisher.CategoryPublisher"/>
						<arg value="-metadataRepository"/>
						<arg value="file:/${updatesite.repository}"/>
						<arg value="-categoryDefinition"/>
						<arg value="file:/${category.definition}"/>
						<arg value="-categoryQualifier"/>
						<arg value="-compress"/>
			</java>	
	</target>
	<target name="get_site_template">
		<copy todir="${updatesite.repository}">
			<fileset dir="${env.WORKSPACE}/src/resources" includes="**" >
				<!--<exclude name="readme.txt"/>
				<exclude name="*_build.xml"/>-->
			</fileset>	
		</copy>
	</target>
	<target name="upload">
		<chmod perm="g+w">
			<fileset dir="${updatesite.repository}">
			    <include name="**/**"/>
			 </fileset>
		</chmod>
		<sshexec host="${deploy.server}"
		         username="${deploy.user}"
				 keyfile="${key.file}"
				 passphrase=""
			     trust="yes"
			     command="rm -Rf ${deploy.path};  
						  mkdir -p ${deploy.path};"/>
		<scp todir="${deploy.user}@${deploy.server}:${deploy.path}"
			keyfile="${key.file}"
			passphrase=""
		    trust="yes">
		    <fileset dir="${updatesite.repository}">
		      <include name="**/**"/>
		    </fileset>
		</scp>
		<!-- override the site.xml with the correct category.xml -->
		<!--<scp file="category.xml" remoteTofile="${deploy.user}@${deploy.server}:${deploy.path}/site.xml"
			keyfile="${key.file}"
			passphrase=""
		    trust="yes">
		</scp>-->
	</target>
	<target name="get_studio_base">
		<ant antfile="get_studio_base_build.xml">
  			<property name="studio.base.url" value="${studio.base.url}"/>
  			<property name="archive.extension" value="${studio.archive.extension}"/>
			<property name="studio.base.dir" location="${studio.base.dir}"/>
		</ant>
	</target>
	<target name="get_repository_source">
		<!--<delete dir="${source.features.and.bundles}" failonerror="false"/>-->
		<mkdir dir="${source.features}" />
		<mkdir dir="${source.bundles}" />
		
		<!-- features -->
		<get src="${kermeta.maven.repsitory}/org/kermeta/language/language.feature/${kermeta.language.version}/language.feature-${kermeta.language.version}.jar" 
			dest="${source.features}"
			usetimestamp="true"/>
		<get src="${kermeta.maven.repsitory}/org/kermeta/utils/utils.feature/${kermeta.language.version}/utils.feature-${kermeta.language.version}.jar" 
			dest="${source.features}"
			usetimestamp="true"/>
		
		<!-- plugins -->
		<!--<get src="${kermeta.maven.repsitory}/org/emftext/commons/commons.antlr3_2_0/${emftext.commons.version}/commons.antlr3_2_0-${emftext.commons.version}.jar" 
			dest="${source.bundles}"
			usetimestamp="true"/>-->
		
		<get src="${kermeta.maven.repsitory}/fr/irisa/triskell/kermeta/kermeta.model/${k1.model.version}/kermeta.model-${k1.model.version}.jar" 
			dest="${source.bundles}"
			usetimestamp="true"/>
		<get src="${kermeta.maven.repsitory}/org/emftext/commons/commons.antlr3_3_0/${emftext.commons.version}/commons.antlr3_3_0-${emftext.commons.version}.jar" 
					dest="${source.bundles}"
					usetimestamp="true"/>
	<!--	<get src="${kermeta.maven.repsitory}/org/kermeta/extra/extra.antlr/${extra.antlr.version}/extra.antlr-${extra.antlr.version}.jar" 
					dest="${source.bundles}"
					usetimestamp="true"/>
		<get src="${kermeta.maven.repsitory}/org/kermeta/extra/extra.antlr.stringtemplate/${extra.antlr.stringtemplate.version}/extra.antlr.stringtemplate-${extra.antlr.stringtemplate.version}.jar" 
							dest="${source.bundles}"
							usetimestamp="true"/>
		-->
		<get src="${kermeta.maven.repsitory}/org/kermeta/scala/scala-compiler/${k1.compiler.version}/scala-compiler-${k1.compiler.version}.jar" 
			dest="${source.bundles}"
			usetimestamp="true"/>
		<get src="${kermeta.maven.repsitory}/org/kermeta/scala/scala-library/${scala.version}/scala-library-${scala.version}.jar" 
			dest="${source.bundles}"
			usetimestamp="true"/>
		<get src="${kermeta.maven.repsitory}/org/kermeta/scala/jline/${scala.version}/jline-${scala.version}.jar" 
			dest="${source.bundles}"
			usetimestamp="true"/>
		
		<get src="${kermeta.maven.repsitory}/org/kermeta/utils/utils.helpers/${kermeta.language.version}/utils.helpers-${kermeta.language.version}.jar" 
			dest="${source.bundles}"
			usetimestamp="true"/>
		<get src="${kermeta.maven.repsitory}/org/kermeta/utils/utils.helpers.eclipse/${kermeta.language.version}/utils.helpers.eclipse-${kermeta.language.version}.jar" 
			dest="${source.bundles}"
			usetimestamp="true"/>
		<get src="${kermeta.maven.repsitory}/org/kermeta/utils/utils.helpers.eclipse.jface/${kermeta.language.version}/utils.helpers.eclipse.jface-${kermeta.language.version}.jar" 
			dest="${source.bundles}"
			usetimestamp="true"/>
		<get src="${kermeta.maven.repsitory}/org/kermeta/utils/utils.provisionner4eclipse/${kermeta.language.version}/utils.provisionner4eclipse-${kermeta.language.version}.jar" 
			dest="${source.bundles}"
			usetimestamp="true"/>
		<get src="${kermeta.maven.repsitory}/org/kermeta/utils/utils.slf4j.eclipse/${kermeta.language.version}/utils.slf4j.eclipse-${kermeta.language.version}.jar" 
			dest="${source.bundles}"
			usetimestamp="true"/>
		<get src="${kermeta.maven.repsitory}/org/kermeta/utils/utils.systemservices.api/${kermeta.language.version}/utils.systemservices.api-${kermeta.language.version}.jar" 
			dest="${source.bundles}"
			usetimestamp="true"/>
		<get src="${kermeta.maven.repsitory}/org/kermeta/utils/utils.systemservices.eclipse/${kermeta.language.version}/utils.systemservices.eclipse-${kermeta.language.version}.jar" 
			dest="${source.bundles}"
			usetimestamp="true"/>
		<get src="${kermeta.maven.repsitory}/org/kermeta/emf/emf.genmodel/${kermeta.language.version}/emf.genmodel-${kermeta.language.version}.jar" 
					dest="${source.bundles}"
					usetimestamp="true"/>
		
		<get src="${kermeta.maven.repsitory}/org/kermeta/kp/kp.model/${kermeta.language.version}/kp.model-${kermeta.language.version}.jar" 
			dest="${source.bundles}"
			usetimestamp="true"/>
		<get src="${kermeta.maven.repsitory}/org/kermeta/kp/kp.editor/${kermeta.language.version}/kp.editor-${kermeta.language.version}.jar" 
			dest="${source.bundles}"
			usetimestamp="true"/>
		<get src="${kermeta.maven.repsitory}/org/kermeta/kp/kp.editor.ui/${kermeta.language.version}/kp.editor.ui-${kermeta.language.version}.jar" 
			dest="${source.bundles}"
			usetimestamp="true"/>
		<get src="${kermeta.maven.repsitory}/org/kermeta/kp/kp.loader.kp.api/${kermeta.language.version}/kp.loader.kp.api-${kermeta.language.version}.jar" 
			dest="${source.bundles}"
			usetimestamp="true"/>
		<get src="${kermeta.maven.repsitory}/org/kermeta/kp/kp.loader.kp/${kermeta.language.version}/kp.loader.kp-${kermeta.language.version}.jar" 
			dest="${source.bundles}"
			usetimestamp="true"/>
		

		<get src="${kermeta.maven.repsitory}/org/kermeta/language/language.model/${kermeta.language.version}/language.model-${kermeta.language.version}.jar" 
			dest="${source.bundles}"
			usetimestamp="true"/>

		<get src="${kermeta.maven.repsitory}/org/kermeta/language/language.loader.kmt.scala.api/${kermeta.language.version}/language.loader.kmt.scala.api-${kermeta.language.version}.jar" 
			dest="${source.bundles}"
			usetimestamp="true"/>

		<get src="${kermeta.maven.repsitory}/org/kermeta/language/language.loader.kmt.scala/${kermeta.language.version}/language.loader.kmt.scala-${kermeta.language.version}.jar" 
			dest="${source.bundles}"
			usetimestamp="true"/>
		<!-- **** -->
		<get src="${kermeta.maven.repsitory}/org/kermeta/language/language.framework.scala/${k1.framework.version}/language.framework.scala-${k1.framework.version}.jar" 
			dest="${source.bundles}"
			usetimestamp="true"/>
		<!-- **** -->
		<get src="${kermeta.maven.repsitory}/org/kermeta/language/language.merger.binarymerger.api/${kermeta.language.version}/language.merger.binarymerger.api-${kermeta.language.version}.jar" 
			dest="${source.bundles}"
			usetimestamp="true"/>
		<get src="${kermeta.maven.repsitory}/org/kermeta/language/language.merger.binarymerger/${kermeta.language.version}/language.merger.binarymerger-${kermeta.language.version}.jar" 
			dest="${source.bundles}"
			usetimestamp="true"/>
		<get src="${kermeta.maven.repsitory}/org/kermeta/language/language.resolver.api/${kermeta.language.version}/language.resolver.api-${kermeta.language.version}.jar" 
			dest="${source.bundles}"
			usetimestamp="true"/>
		<get src="${kermeta.maven.repsitory}/org/kermeta/language/language.resolver/${kermeta.language.version}/language.resolver-${kermeta.language.version}.jar" 
			dest="${source.bundles}"
			usetimestamp="true"/>
		<get src="${kermeta.maven.repsitory}/org/kermeta/diagnostic/diagnostic.model/${kermeta.language.version}/diagnostic.model-${kermeta.language.version}.jar" 
			dest="${source.bundles}"
			usetimestamp="true"/>
		<get src="${kermeta.maven.repsitory}/org/kermeta/traceability/traceability.model/${traceability.version}/traceability.model-${traceability.version}.jar" 
			dest="${source.bundles}"
			usetimestamp="true"/>
		<get src="${kermeta.maven.repsitory}/org/kermeta/language/language.checker.api/${kermeta.language.version}/language.checker.api-${kermeta.language.version}.jar" 
			dest="${source.bundles}"
			usetimestamp="true"/>
		<get src="${kermeta.maven.repsitory}/org/kermeta/language/language.checker/${kermeta.language.version}/language.checker-${kermeta.language.version}.jar" 
			dest="${source.bundles}"
			usetimestamp="true"/>
		<get src="${kermeta.maven.repsitory}/org/kermeta/language/language.ecore2km.api/${kermeta.language.version}/language.ecore2km.api-${kermeta.language.version}.jar" 
			dest="${source.bundles}"
			usetimestamp="true"/>
		<get src="${kermeta.maven.repsitory}/org/kermeta/language/language.ecore2km/${kermeta.language.version}/language.ecore2km-${kermeta.language.version}.jar" 
			dest="${source.bundles}"
			usetimestamp="true"/>
		<get src="${kermeta.maven.repsitory}/org/kermeta/language/language.library.core/${kermeta.language.version}/language.library.core-${kermeta.language.version}.jar" 
			dest="${source.bundles}"
			usetimestamp="true"/>
		<get src="${kermeta.maven.repsitory}/org/kermeta/language/language.km2bytecode/${kermeta.language.version}/language.km2bytecode-${kermeta.language.version}.jar" 
			dest="${source.bundles}"
			usetimestamp="true"/>
		<get src="${kermeta.maven.repsitory}/org/kermeta/kp/kp.compiler.commandline/${kermeta.language.version}/kp.compiler.commandline-${kermeta.language.version}.jar" 
			dest="${source.bundles}"
			usetimestamp="true"/>
		<get src="${kermeta.maven.repsitory}/org/kermeta/language/language.builder.api/${kermeta.language.version}/language.builder.api-${kermeta.language.version}.jar" 
			dest="${source.bundles}"
			usetimestamp="true"/>
		<get src="${kermeta.maven.repsitory}/org/kermeta/language/language.builder.eclipse/${kermeta.language.version}/language.builder.eclipse-${kermeta.language.version}.jar" 
			dest="${source.bundles}"
			usetimestamp="true"/>
		<get src="${kermeta.maven.repsitory}/org/kermeta/language/language.autocompletion.api/${kermeta.language.version}/language.autocompletion.api-${kermeta.language.version}.jar" 
			dest="${source.bundles}"
			usetimestamp="true"/>
		<get src="${kermeta.maven.repsitory}/org/kermeta/language/language.autocompletion/${kermeta.language.version}/language.autocompletion-${kermeta.language.version}.jar" 
			dest="${source.bundles}"
			usetimestamp="true"/>
		<get src="${kermeta.maven.repsitory}/org/kermeta/language/language.texteditor.eclipse/${kermeta.language.version}/language.texteditor.eclipse-${kermeta.language.version}.jar" 
			dest="${source.bundles}"
			usetimestamp="true"/>
		<get src="${kermeta.maven.repsitory}/org/kermeta/language/language.texteditor.eclipse.nature/${kermeta.language.version}/language.texteditor.eclipse.nature-${kermeta.language.version}.jar" 
			dest="${source.bundles}"
			usetimestamp="true"/>
		<get src="${kermeta.maven.repsitory}/org/kermeta/kp/kp.launcher.eclipse/${kermeta.language.version}/kp.launcher.eclipse-${kermeta.language.version}.jar" 
			dest="${source.bundles}"
			usetimestamp="true"/>
		<get src="${kermeta.maven.repsitory}/org/kermeta/kp/kp.migrateRequireV1ToKp.eclipse.ui/${kermeta.language.version}/kp.migrateRequireV1ToKp.eclipse.ui-${kermeta.language.version}.jar" 
			dest="${source.bundles}"
			usetimestamp="true"/>
		<get src="${kermeta.maven.repsitory}/org/kermeta/kp/kp.wizard.eclipse/${kermeta.language.version}/kp.wizard.eclipse-${kermeta.language.version}.jar" 
			dest="${source.bundles}"
			usetimestamp="true"/>
		<get src="${kermeta.maven.repsitory}/fr/irisa/triskell/utilities/cache.utilities/${triskell.utilities.version}/cache.utilities-${triskell.utilities.version}.jar" 
			dest="${source.bundles}"
			usetimestamp="true"/>
		
		<!-- external repo -->
		<get src="http://repo1.maven.org/maven2/org/ops4j/pax/url/pax-url-mvn/1.3.4/pax-url-mvn-1.3.4.jar" 
						dest="${source.bundles}"
						usetimestamp="true"/>
		<get src="http://repo1.maven.org/maven2/org/ops4j/pax/url/pax-url-assembly/1.3.4/pax-url-assembly-1.3.4.jar" 
						dest="${source.bundles}"
						usetimestamp="true"/>
		
		
		 	
	</target>
</project>