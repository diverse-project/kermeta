<project name="compile_log4j" default="compile">
	<!-- configuration properties -->		
	<!-- project configuration -->
	<property environment="env"/>

	<property name="env.WORKSPACE" location="/local/hudson/home/jobs/compile_kermeta/workspace"/>
	<property name="prepare.Kermeta.sources.last.successfull.dir" location="${env.WORKSPACE}/../../prepare Kermeta sources/lastSuccessful/archive"/>
	<property name="prepare.OpenEmbeDD.sources.last.successfull.dir" location="${env.WORKSPACE}/../../prepare OpenEmbeDD sources/lastSuccessful/archive"/>
	<property name="previousStep.dir" location="${env.WORKSPACE}/previousStep"/>
	<property name="eclipse.home" location="/local/daily_build/eclipse3.4_with_topcased/eclipse"/>
	<property name="equinox.jar" location="${eclipse.home}/plugins/org.eclipse.equinox.launcher_1.0.101.R34x_v20080819.jar"/>
	<property name="eclipse.workspace.dir" location="${env.WORKSPACE}/eclipseworkspace"/>	
	<property name="eclipse.build.dir" location="${env.WORKSPACE}/src"/>
	<property name="eclipse.extension.location" location="${env.WORKSPACE}/extension_location"/>
	
	<target name="all" depends="compile">
		
	</target>
		
	<target name="organizeSources">	
		<mkdir dir="${eclipse.build.dir}"/>	
		<mkdir dir="${eclipse.build.dir}/plugins"/>
		<mkdir dir="${eclipse.build.dir}/features"/>		
		<copy todir="${eclipse.build.dir}/features/fr.irisa.triskell.kermeta">
			<fileset dir="${env.WORKSPACE}/kermeta_projects/fr.irisa.triskell.kermeta.feature">
				 <exclude name="**/CVS/**"/>
			</fileset>
		</copy>		
		<copy todir="${eclipse.build.dir}/plugins">
			<fileset dir="${env.WORKSPACE}/kermeta_projects">
				 <exclude name="**/fr.irisa.triskell.kermeta.feature/**"/>
				 <exclude name="**/fr.irisa.triskell.kermeta.ket/**"/>
				 <exclude name="**/org.kermeta.prototyper/**"/>
				 <exclude name="**/org.kermeta.kpm.test.workbench/**"/>
				 <exclude name="**/org.kermeta.compiler.tests/**"/>
				 <exclude name="**/org.kermeta.ket.texteditor/**"/>
				 <exclude name="**/org.kermeta.compiler/**"/>
				 <exclude name="**/org.kermeta.kpm.tests/**"/>
				 <exclude name="**/fr.irisa.triskell.kermeta.graphicaleditor/**"/>
				 <exclude name="**/org.kermeta.compiler.generator/**"/>
				 <exclude name="**/org.kermeta.compiler.trek.ui/**"/>
				 <exclude name="**/org.kermeta.compiler.ui/**"/>
				 <exclude name="**/CVS/**"/>
			</fileset>
		</copy>

	</target>
	<target name="getDependencies">	
		<mkdir dir="${eclipse.extension.location}"/>			
		<get src="http://pamplemousse.irisa.fr:8080/job/compile_traceability/lastSuccessfulBuild/artifact/src/I.TestBuild/fr.irisa.triskell.traceability-TestBuild.zip" 
			dest="${eclipse.extension.location}/fr.irisa.triskell.traceability-TestBuild.zip"
			usetimestamp="true"/>
		<get src="http://pamplemousse.irisa.fr:8080/job/compile_log4j/lastSuccessfulBuild/artifact/src/I.TestBuild/org.kermeta.log4j-TestBuild.zip" 
					dest="${eclipse.extension.location}/org.kermeta.log4j-TestBuild.zip"
					usetimestamp="true"/>
	<!--	<get src="http://pamplemousse.irisa.fr:8080/job/compile_gymnast_runtime/lastSuccessfulBuild/artifact/src/I.TestBuild/org.eclipse.gymnast.runtime.core.feature-TestBuild.zip" 
							dest="${eclipse.extension.location}/org.eclipse.gymnast.runtime.core.feature-TestBuild.zip"
							usetimestamp="true"/>
		<get src="http://pamplemousse.irisa.fr:8080/view/KermetaValidatedOnTheNewForge/job/compile_antlr2/lastSuccessfulBuild/artifact/src/I.TestBuild/org.antlr.antlr2.feature-TestBuild.zip" 
									dest="${eclipse.extension.location}/org.antlr.antlr2.feature-TestBuild.zip"
									usetimestamp="true"/>
		<get src="http://pamplemousse.irisa.fr:8080/view/KermetaValidatedOnTheNewForge/job/compile_registration/lastSuccessfulBuild/artifact/src/I.TestBuild/org.eclipse.emf.ecoretools.registration-TestBuild.zip" 
											dest="${eclipse.extension.location}/org.eclipse.emf.ecoretools.registration-TestBuild.zip"
											usetimestamp="true"/>
     -->											
		<unzip dest="${eclipse.extension.location}">
		    <fileset dir="${eclipse.extension.location}">
		        <include name="**/*.zip"/>
		    </fileset>
		</unzip>

	</target>
		
	<target name="compile" depends="organizeSources, getDependencies">	
		<mkdir dir="${eclipse.workspace.dir}"/>
		<java jar="${equinox.jar}"
		           fork="true"
		           failonerror="true"
		           maxmemory="128m"
		           >
			<arg value="-application"/>
			<arg value="org.eclipse.ant.core.antRunner"/>
			<arg value="-buildfile"/>
			<arg value="${eclipse.home}/plugins/org.eclipse.pde.build_3.4.1.R34x_v20080805/scripts/build.xml"/>
			<arg value="-data"/>
			<arg value="${eclipse.workspace.dir}"/>
			<arg value="-Dbuilder=${env.WORKSPACE}/hudson_scripts/compile_kermeta/eclipse_build_scripts"/>
		</java>
	

	</target>
</project>