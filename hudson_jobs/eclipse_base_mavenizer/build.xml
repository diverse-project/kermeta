<project name="build_eclipse_bases_for_kermeta" default="all">

	<property name="env.WORKSPACE" location="."/>
	<property name="lib.folder" location="${env.WORKSPACE}/lib"/>
	<property name="eclipse.native.version.name" value="linux_x86_64"/>
	<property name="eclipse.native.archive.extension" value="zip"/>
	<property name="eclipse.native.base.url" value="http://www.kermeta.org/integration_build/base_packages/kermeta_helios_linux_x86_64_base.zip"/>
	<property name="smofd.jar" value="tools.simple.maven.osgi.file.deploy-1.0.0-SNAPSHOT.jar"/>
	<property name="simple.maven.osgi.file.deploy.url" value="http://tipimouss.irisa.fr/maven2-snapshots/org/kermeta/tools/tools.simple.maven.osgi.file.deploy/1.0.0-SNAPSHOT/tools.simple.maven.osgi.file.deploy-1.0.0-SNAPSHOT.jar"/>
	<property name="jars.folder" location="${env.WORKSPACE}/eclipse_galileo_${eclipse.native.version.name}_base/eclipse/plugins"/>
	
	
	<property name="group.id" value="org.kermeta.eclipse"/>
	<property name="deployment.url" value="http://maven.irisa.fr/artifactory/kermeta-public-release"/>
	<property name="repository.id" value="kermeta-public-release"/>
	
	<target name="all" depends="">
	    <antcall target="get_executable_libs"/>
	    <antcall target="get_deployable_jars"/>
	    <antcall target="deploy"/>
	</target>	
	<target name="get_executable_libs">
		<echo>Step 1 - Retrieve latest version of the executables</echo>
		<mkdir dir="${lib.folder}"/>
		<get src="${simple.maven.osgi.file.deploy.url}" 
							dest="${lib.folder}/${smofd.jar}"
							usetimestamp="true"/>
	</target>
	<target name="get_deployable_jars">
		<echo>Step 2 - Preparation of the jars that will be deployed</echo>
		<ant antfile="get_eclipse_base_build.xml">
  			<property name="eclipse.version.name" value="${eclipse.native.version.name}"/>
  			<property name="archive.extension" value="${eclipse.native.archive.extension}"/>
  			<property name="eclipse.base.url" value="${eclipse.native.base.url}"/>
		</ant>
		<delete>
			<fileset dir="${jars.folder}" includes="org.eclipse.text.source_*.jar"/>
		</delete>
	</target>
	
	<target name="deploy" >
		<echo>Step 3 - Deploy jars to the repository</echo>
		<java jar="${lib.folder}/${smofd.jar}"
		           fork="true"
		           failonerror="true"
		           maxmemory="256m"
		           >
			<arg value="-simulate"/>
			<arg value="-jarfolder"/>
			<arg value="${jars.folder}"/>
			<arg value="-groupid"/>
			<arg value="${group.id}"/>
			<arg value="-repositoryid"/>
			<arg value="${repository.id}"/>
			<arg value="-url"/>
			<arg value="${deployment.url}"/>
		</java>
	</target>
</project>