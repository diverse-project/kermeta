/* File:      p2h_config.P -- loader for the prolog to hilog module
** Author(s): kifer
** Contact:   flora-users@lists.sourceforge.net
** 
** Copyright (C) The Research Foundation of SUNY, 2000
** 
** FLORA-2 is free software; you can redistribute it and/or modify it under the
** terms of the GNU Library General Public License as published by the Free
** Software Foundation; either version 2 of the License, or (at your option)
** any later version.
** 
** FLORA-2 is distributed in the hope that it will be useful, but WITHOUT ANY
** WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
** FOR A PARTICULAR PURPOSE.  See the GNU Library General Public License for
** more details.
** 
** You should have received a copy of the GNU Library General Public License
** along with FLORA-2; if not, write to the Free Software Foundation,
** Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
**
** $Id: p2h_config.P,v 1.6 2005/01/05 22:31:49 kifer Exp $
** 
*/

%% bootstrap_flora/0 adds this directory to the library search path.
%% Loading p2h_config.P ensures that the module prolog2hilog is compiled 
%% and loaded.

:- compiler_options([xpp_on]).
#include "flora_porting.flh"


:- import
	flora_slash/1,
	flora_concat_atoms/2,
	flora_file_op/3,
	flora_file_op/2,
	flora_running_under/1
    from flrporting.
:- import flora_configuration/2 from flrregistry.
:- import search_module/6 from consult.
:- import xsb_configuration/2 from xsb_configuration.
:- import shell/1 from shell.

?-  flora_configuration(installdir, FloraDir),
    flora_slash(Slash),
    Basename = prolog2hilog,
    xsb_configuration(config_libdir, ConfigLibdir),
    flora_concat_atoms([ConfigLibdir,Slash,Basename,'.',PROLOG_OFILE_EXT],
		       LibObjFile),
    flora_concat_atoms([FloraDir,Slash,p2h,Slash,Basename],Module),
    flora_concat_atoms([Module,'.', PROLOG_OFILE_EXT], Objfile),
    (   %% avoid recompilation: check if prolog2hilog.OBJ exists and 
	%% is newer than prolog2hilog.c.
	search_module(Basename,Dir,_Mod,_Ext,_Base,ModuleO),
	flora_concat_atoms([Module, '.c'], ModuleSourceFile),
	flora_file_op(newerthan,ModuleO,ModuleSourceFile)
    %% module compiled and is current, so just load
    -> [Basename]

    ; (flora_running_under(windows) ; flora_running_under(cygwin))
    ->
	xsb_configuration(config_bindir, ConfigBindir),
	flora_concat_atoms([Module, '.dll'],CygModDLL),
	flora_concat_atoms([FloraDir,Slash,'p2h\windows',Slash,Basename,'.dll'],WinModDLL),
	flora_concat_atoms([ConfigBindir,Slash,Basename,'.dll'],TargetDLL),
	(flora_running_under(cygwin)
	->
	    consult(Module, []),
	    flora_file_op(rename,CygModDLL, TargetDLL),
	    %% clean up
	    flora_concat_atoms([Module, '.a'],CygModA),
	    flora_concat_atoms([Module, '.o'],CygModO),
	    flora_concat_atoms([Module, '.def'],CygModDEF),
	    flora_file_op(unlink,CygModA),
	    flora_file_op(unlink,CygModO),
	    flora_file_op(unlink,CygModDEF)
	; 
	    /*
	    %% This seems to be copying ASCII files in windoze, so use shell
	    flora_file_op(copy,WinModDLL, TargetDLL),
	    */
	    shell(['copy /B /Y ', WinModDLL, ' ', TargetDLL])
	),
	[Basename],
	flora_file_op(rename,Objfile,LibObjFile)

    %% If Module isn't compiled or is old --- recompile
    ;   xsb_configuration(compiler, CC),
	consult(Module, [cc(CC), cc_opts(' ')]),
	flora_file_op(rename,Objfile, LibObjFile),
	( % MacOS
	flora_running_under(darwin)
	->
	    %% Note: the .dylib ending is Mac-specific.
	    flora_concat_atoms([Module, '.dylib'], SharedLib),
	    flora_concat_atoms([ConfigLibdir,Slash,Basename,'.dylib'], LibMod),
	    flora_file_op(rename,SharedLib,LibMod)
	;
	flora_running_under(unix)
	->
	    %% Note: the .so ending is Unix-specific.
	    %% We don't need to run this script under Windows
	    flora_concat_atoms([Module, '.so'], SharedLib),
	    flora_concat_atoms([ConfigLibdir,Slash,Basename,'.so'], LibMod),
	    flora_file_op(rename,SharedLib,LibMod)
	;
	  true
	)
     ).
