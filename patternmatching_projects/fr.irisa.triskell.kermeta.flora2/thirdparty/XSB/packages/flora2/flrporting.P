/* File:      flrporting.P  -- Non-standard Prolog predicates used in Flora
**
** Author(s): Michael Kifer
**
** Contact:   flora-users@lists.sourceforge.net
**
** Copyright (C) The Research Foundation of SUNY, 2002
**
** FLORA-2 is free software; you can redistribute it and/or modify it under the
** terms of the GNU Library General Public License as published by the Free
** Software Foundation; either version 2 of the License, or (at your option)
** any later version.
**
** FLORA-2 is distributed in the hope that it will be useful, but WITHOUT ANY
** WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
** FOR A PARTICULAR PURPOSE.  See the GNU Library General Public License for
** more details.
**
** You should have received a copy of the GNU Library General Public License
** along with FLORA-2; if not, write to the Free Software Foundation,
** Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
**
** $Id: flrporting.P,v 1.27 2006/09/10 18:52:18 kifer Exp $
**
*/


:- compiler_options([xpp_on,spec_off]).

#include "token_defs_xsb.h"
%% DO NOT include any FLORA .flh files here, or else FLORA won't
%% build correctly when installed outside of the XSB tree

#define CH_QUOTE  39


:- import conget/2, conset/2 from gensym.
:- import eval/2 from eval.
:- import
	slash/1,
	str_len/2,
	file_writequoted/2,
	file_puttoken/3
   from machine.
:- import
	substring/4,
	term_to_atom/3
   from string.
:- import library_directory/1 from usermod.
:- import xsb_configuration/2 from xsb_configuration.
:- import
	path_sysop/2, path_sysop/3, copyIOport/2,
	file_read_line_atom/1, file_read_line_list/1
	from file_io.

:- import banner_control/1 from banner.

:- import flora_abort/1 from flrutils.

:- import flora_configuration/2 from flrregistry.

:- export
	flora_write_quoted_atom/1,
	flora_write_atom_quoted_as_needed/1,
	flora_write_atom/1,
	flora_slash/1,
	flora_running_under/1,
	flora_file_op/2,
	flora_file_op/3,
	flora_read_line_as_atom/1,
	flora_read_line_as_list/1,
	flora_copy_input/0,
	flora_copy_input/2,
	flora_user_home/1,
	flora_install_dir/1,
	flora_atom_length/2,
	flora_match_substring/3,
	flora_match_substring/5,
	flora_get_substring/4,
	flora_term_to_atom/2,
	flora_concat_items/2,
	flora_concat_atoms/2,
	flora_set_counter/2,
	flora_get_counter/2,
	flora_increment_counter/4,
	flora_cputime/1,
	flora_module_path_get/1,
	flora_module_path_add/1,
	flora_module_path_remove/1,
	flora_banner_control/1,
	flora_double_backslash/2,
	flora_convert_win_path_to_cygwin/2.


flora_term_to_atom(Term,Atom) :-
	term_to_atom(Term,Atom,[ignore_ops(canonical),quoted(false)]).
	%%fmt_write_string(Atom,'%S',arg(Term)).

%% This concats items or any type - atoms, numbers, etc.
%% Make the most common case fast!
flora_concat_items([Item1,Item2],Atom) :-
	!,
	fmt_write_string(Atom, '%S%S', arg(Item1,Item2)).
flora_concat_items([Item|ItemList],Atom) :-
	%%fmt_write_string(Atom1, '%S', arg(Item)),
	flora_term_to_atom(Item,Atom1),
	flora_concat_items(ItemList,Atom2),
	atom_concat(Atom1,Atom2,Atom).
flora_concat_items([],'').

%% If all members are atoms, this is more efficient
%% Make the most common case fast!
flora_concat_atoms([Atom1,Atom2],Atom) :- !, atom_concat(Atom1,Atom2,Atom).
flora_concat_atoms([Atom1|AtomList],Atom) :-
	flora_concat_atoms(AtomList,Atom2),
	atom_concat(Atom1,Atom2,Atom).
flora_concat_atoms([],'').
	


flora_atom_length(Atom,Length) :- str_len(Atom, Length).


flora_get_counter(Counter,Value) :- conget(Counter,Value).
flora_set_counter(Counter,Value) :- conset(Counter,Value).
flora_increment_counter(Counter,Increment,OldValue,NewValue) :-
	eval(Increment,I),
	conget(Counter,OldValue),
	NewValue is OldValue + I,
	conset(Counter,NewValue).

%% Flora wrappers for str_match in XSB's syslib/string.P
%% Checks if Substr matches Str in a given direction and at the right position
flora_match_substring(Substr,Str,Pos) :-
	str_match(Substr,Str,forward,Pos,_).
flora_match_substring(Sub,Str,Direction,Beg,End) :-
	str_match(Sub,Str,Direction,Beg,End).

%% extract substring Subst from String at positions From - To
flora_get_substring(String,From,To,Subst) :- substring(String,From,To,Subst).

flora_slash(Slash) :- slash(Slash).

flora_cputime(X) :- cputime(X).


%% Manipulation of module search path
%% Yap uses path/1, add_to_path/1, remove_from_path/1
flora_module_path_add(Path)    :- assert(library_directory(Path)).
flora_module_path_remove(Path) :- retractall(library_directory(Path)).

flora_module_path_get('.').
flora_module_path_get(Path) :- library_directory(Path).
flora_module_path_get(Path) :-
	xsb_configuration(libdir,LibPath), LibPath = Path.
flora_module_path_get(Path) :-
	xsb_configuration(syslibdir,SyslibPath), SyslibPath=Path.
flora_module_path_get(Path) :-
	xsb_configuration(cmplibdir,CmplibPath), CmplibPath = Path.


%% User Home
flora_user_home(Path) :- xsb_configuration(user_home,Path).

%% where Flora is installed
flora_install_dir(Path) :- flora_configuration(installdir,Path).

%% File system-related
flora_file_op(exists,File)          :- path_sysop(exists,File).
flora_file_op(readable,File)        :- path_sysop(readable,File).
flora_file_op(writable,File)        :- path_sysop(writable,File).
flora_file_op(executable,File)      :- path_sysop(executable,File).
flora_file_op(modtime,File)         :- path_sysop(modtime,File).
flora_file_op(mkdir,Dir)            :- path_sysop(mkdir,Dir).
flora_file_op(rmdir,Dir)            :- path_sysop(rmdir,Dir).
flora_file_op(chdir,Dir)            :- path_sysop(chdir,Dir).
flora_file_op(cwd,Dir)              :- path_sysop(cwd,Dir).
flora_file_op(link,Srs,Dest)        :- path_sysop(link,Srs,Dest).
flora_file_op(unlink,File)          :- path_sysop(unlink,File).
flora_file_op(rm,File)              :- path_sysop(unlink,File).
flora_file_op(tmpfilename,File)     :- path_sysop(tmpfilename,File).
flora_file_op(isabsolute,File)      :- path_sysop(isabsolute,File).
flora_file_op(rename,File,ToFile)   :- path_sysop(rename,File,ToFile).
flora_file_op(basename,File,Base)   :- path_sysop(basename,File,Base).
flora_file_op(extension,File,Ext)   :- path_sysop(extension,File,Ext).
flora_file_op(expand,File,Expanded) :- path_sysop(expand,File,Expanded).
flora_file_op(newerthan,File,File2) :- path_sysop(newerthan,File,File2).
flora_file_op(dirname,File,Dir)     :- path_sysop(dirname,File,Dir).
flora_file_op(copy,From,To)         :- path_sysop(copy,From,To).


%% Copies stdin to stdout
flora_copy_input :-
	seeing(StdIn),
	telling(StdOut),
	copyIOport(StdIn,StdOut).

%% From, To are file names. Variable means stdin or stdout, respectively
flora_copy_input(From,To) :-
	(var(From), !  ; seeing(OldIn), see(From)),
	(var(To), !    ; telling(OldOut), tell(To)),
	flora_copy_input,
	(var(From), !  ; seen, see(OldIn)),
	(var(To), !    ; told, tell(OldOut)).


flora_write_atom_quoted_as_needed(Atom) :-
	\+atom(Atom),
	flora_abort(['flora_write_atom_quoted_as_needed: Non-atom argument, ', Atom]).
flora_write_atom_quoted_as_needed(Atom) :-
	telling(StdOut),
	file_writequoted(StdOut,Atom).

%% Write atoms in correct form for reading. Always quote, even if not necessary
flora_write_quoted_atom(Atom) :-
	\+atom(Atom),
	flora_abort(['flora_write_quoted_atom: Non-atom argument, ', Atom]).
/*
flora_write_quoted_atom(Atom) :-
	telling(StdOut),
	file_writequoted(StdOut,Atom).
	%%file_puttoken(StdOut,TK_QATOM,Atom).
*/
flora_write_quoted_atom(Atom) :-
	atom_codes(Atom,Codes),
	put(CH_QUOTE),
	write_atom_doubling_quotes(Codes),
	put(CH_QUOTE).

write_atom_doubling_quotes([]) :- !.
write_atom_doubling_quotes([CH_QUOTE|Rest]) :-
	!,
	put(CH_QUOTE),
	put(CH_QUOTE),
	write_atom_doubling_quotes(Rest).
write_atom_doubling_quotes([Ch|Rest]) :-
	put(Ch),
	write_atom_doubling_quotes(Rest).

%% Unquoted atom
flora_write_atom(Atom) :-
	telling(StdOut),
	file_puttoken(StdOut,TK_ATOM,Atom).

flora_read_line_as_atom(Str) :- file_read_line_atom(Str).
flora_read_line_as_list(Str) :- file_read_line_list(Str).


:- table flora_running_under/1.

flora_running_under(cygwin) :-
	xsb_configuration(architecture,A),
	str_sub(cygwin,A),
	!.
flora_running_under(windows) :-
	xsb_configuration(architecture,A),
	str_sub(windows,A),
	!.
flora_running_under(macos) :-
	xsb_configuration(architecture,A),
	str_sub(darwin,A),
	!.
flora_running_under(darwin) :-
	xsb_configuration(architecture,A),
	str_sub(darwin,A),
	!.
flora_running_under(unix) :-
	\+ flora_running_under(cygwin),
	\+ flora_running_under(windows),
	\+ flora_running_under(macos).


flora_banner_control(X) :- banner_control(X).


flora_convert_win_path_to_cygwin(WinP,CygwinP) :-
	atom_codes(WinP,WinPlist),
	WinPlist = [Letter, 0': | Rest],
	(
	  (0'a =< Letter, Letter =< 0'z)
	; (0'A =< Letter, Letter =< 0'Z)
	),
	!,
	%% Letter drive plus ":"
	convert_backslash_to_forward(Rest,NewRest),
	atom_codes(LetterAtom,[Letter]),
	atom_codes(NewRestAtom,NewRest),
	flora_concat_atoms(['/',cygdrive,'/',LetterAtom,NewRestAtom],CygwinP).
	
	%% If not a window path - leave as is
flora_convert_win_path_to_cygwin(Path,Path).


#define BACKSLASH 92
convert_backslash_to_forward([],[]) :-
	!.
convert_backslash_to_forward([BACKSLASH | Back], [0'/ | Forward]) :-
	!,
	convert_backslash_to_forward(Back,Forward).
convert_backslash_to_forward([Ch | Back], [Ch | Forward]) :-
	convert_backslash_to_forward(Back,Forward).


flora_double_backslash(Path,PathDouble) :-
	atom_codes(Path,PathLst),
	double_backslash_list(PathLst,PathLstDouble),
	atom_codes(PathDouble,PathLstDouble).

double_backslash_list([],[]).
double_backslash_list([BACKSLASH|Rest], [BACKSLASH,BACKSLASH|DoubleRest]) :-
	!,
	double_backslash_list(Rest, DoubleRest).
double_backslash_list([Ch|Rest], [Ch|DoubleRest]) :-
	double_backslash_list(Rest, DoubleRest).
	
