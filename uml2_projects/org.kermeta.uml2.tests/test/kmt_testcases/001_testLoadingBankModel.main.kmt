/* $Id: $
 * Creation date: October 15, 2007
 * License:
 * Copyright:
 * Authors:
 */
@mainClass "uml2BankLoading::Main"
@mainOperation "main"


package uml2BankLoading;


require kermeta
require "http://www.eclipse.org/uml2/2.1.0/UML"

using kermeta::standard
using kermeta::persistence
using kermeta::kunit
using uml

class Main inherits TestCase
{

	attribute models : String[0..*]

	operation main() : Void is do 
		var tr : TestRunner init TestRunner.new
		tr.run(Main)
		tr.printTestResult		
	end

	operation testLoadModel() is do
		var modelURI : String init "platform:/plugin/org.kermeta.uml2.tests/test/models/bank.uml"
		var repository : EMFRepository init EMFRepository.new
		var resource : Resource init repository.getResource( modelURI )
		if ( resource.contents.one.isInstanceOf(Model) ) then
			assertWithMsg(true, modelURI + " has been correctly loaded.")
			var model : Model
			model ?= resource.contents.one
			var p : uml::Package
			p ?= model.packagedElement.one
			assert( p.name.equals("bank") )
		else
			assertWithMsg(false, modelURI + " could not have been loaded.")
		end
	end
	
	operation testSaveAndReloadModel() is do
		var modelURI : String init "platform:/plugin/org.kermeta.uml2.tests/test/models/bank.uml"
		var repository : EMFRepository init EMFRepository.new
		var resource : Resource init repository.getResource( modelURI )
		if ( resource.contents.one.isInstanceOf(Model) ) then
			assertWithMsg(true, modelURI + " has been correctly loaded.")
			var model : Model
			model ?= resource.contents.one
			var p : uml::Package
			p ?= model.packagedElement.one
			assert( p.name.equals("bank") )
		else
			assertWithMsg(false, modelURI + " hasn't been loaded correctly.")
		end
		// this may fails due to bug #7660
		var modelNewURI : String init "../models/output/bank.out.uml"
		resource.saveWithNewURI(modelNewURI)
		
		// reload
		var repository2 : EMFRepository init EMFRepository.new
		var resource2 : Resource init repository2.getResource( modelNewURI )
		if ( resource2.contents.one.isInstanceOf(Model) ) then
			assertWithMsg(true, modelNewURI + " has been correctly loaded.")
			var model : Model
			model ?= resource2.contents.one
			var p : uml::Package
			p ?= model.packagedElement.one
			assert( p.name.equals("bank") )
		else
			assertWithMsg(false, modelNewURI + " hasn't been loaded correctly.")
		end
		
		
	end

}