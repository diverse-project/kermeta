@mainClass "uml2kmt_visitor::Uml2KMTVisitor"
@mainOperation "main"

package uml2kmt_visitor;


require kermeta
//require "Uml2.kmt"
require "../ecore/UML2.ecore"
require "TopDownVisitor.kmt"

using kermeta::standard

class Uml2KMTVisitor inherits topdown_visitor::TopDownVisitor
{
    attribute currentIndentLevel : Integer
    attribute indentValue : String
    
    attribute kmtFile : kermeta::io::StdIO
    
    attribute modelMembers : Set<Object>
    
    operation initialize(uri : String, mm_uri : String) : Set<Object> is do
    	// variables that which must be initialized
    	currentIndentLevel := 0
    	indentValue := "	"
    	kmtFile := stdio.new
    	
    	// load the given model
    	var repository : kermeta::persistence::EMFRepository init kermeta::persistence::EMFRepository.new
    	var resource : kermeta::persistence::EMFResource init repository.createResource(uri, mm_uri)
    	resource.load()
    	modelMembers := resource.instances
    end
    
    /**
     * Give the caller the desired indentation,
     * to be inserted at the beginning of the code line
     */
    operation indent() : String is do
    	var s : String init ""
    	from var i : Integer init 0
    	until i < currentIndentLevel
    	loop
    		s := s + indentValue
    		i := i + 1
    	end
    	result := s
    end
    
    operation uml2kmt() is do
    	// the first member should be the root package
    	var root : uml2::Package
    	root ?= modelMembers.first
    	if root != void
    	then
    		// realise the code of the whole .kmt file
    		kmtFile.writeln("/* Autogenerated Kermeta code file")
    		kmtFile.writeln(" * from an UML2 model with Uml2KMT tool.")
    		kmtFile.writeln(" */ \n")
    		
    		kmtFile.writeln("package " + root.name + ";\n")
    		
    		kmtFile.writeln("require kermeta")
    		kmtFile.writeln("require \"Uml2.kmt\"")
    		kmtFile.writeln("")
    		kmtFile.writeln("using kermeta::standard")
    		kmtFile.writeln("using uml2")
    		kmtFile.writeln("")
    		
    		// TODO : manage the sub packages
    		
    		super()
    	else
    		
    	end
    end
    
    method visitComment(visitable : uml2::Comment) is do
    	kmtFile.writeln(indent() + "/* " + visitable.body + " */")
    	super()
    end
    
    method visitClass(visitable : uml2::Class) is do
    	// declares the class ...
    	if visitable.~abstract then
	    	kmtFile.write(indent() + "abstract class " + visitable.name)
	    else
	    	kmtFile.write(indent() + "class " + visitable.name)
	    end
	    // ... and extracts the inheritage(s) of the class
	    var generalizationNum : Integer init 0
		visitable.generalization.each{e | do
				generalizationNum := generalizationNum + 1
				if generalizationNum == 1 then
					kmtFile.write("inherits " + e.general.name)
				else
					kmtFile.write(", " + e.general.name)
				end
			end}
    	kmtFile.writeln("")
	    
	    // realizes the bloc of the class
    	kmtFile.writeln(indent() + "{")
    	currentIndentLevel := currentIndentLevel + 1
    	super()
    	currentIndentLevel := currentIndentLevel - 1
    	kmtFile.writeln(indent() + "}")
    end
    
    method visitOperation(visitable : uml2::Operation) is do
    	// TODO
    end
    
    method visitParameter(visitable : uml2::Parameter) is do
    	// TODO
    end
    
    method visitPackage(visitable : uml2::Package) is do
    	// TODO
    end
    
    method visitDataType(visitable : uml2::Comment) is do
    	// TODO
    end
    
    method visitClassifier(visitable : uml2::Classifier) is do
    	// TODO
    end
    
/*    method visitLitteralUnlimitedNatural(visitable : uml2::LitteralUnlimitedNatural) is do
    	// TODO
    end */
    
    /**
     * this method must not be implemented because generalization should
     * be integrated in the declaration of a class, not in its code block
     */
    method visitGeneralization(visitable : uml2::Generalization) is do
    	// nothing to be done
    end
    
    method visitAssociation(visitable : uml2::Association) is do
    	// TODO
    end
    
    /**
     * this method exists for testing purposes
     */
    operation main() is do
    	stdio.writeln("initializing the model !")
    	initialize("ClassDiagram.uml2", "../../test/kmt_test_cases/uml2/")
    	stdio.writeln("running uml2kmt tool !")
    	uml2kmt()
    	stdio.writeln("end of the programm.")
    end
}