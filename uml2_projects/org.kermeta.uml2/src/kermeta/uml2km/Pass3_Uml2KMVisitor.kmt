/* $Id: Pass3_Uml2KMVisitor.kmt,v 1.2 2009-02-18 10:22:51 vmahe Exp $
 * Creation date: May 10, 2006
 * License:
 * Copyright:
 * Authors: vmahe@irisa.fr
 */
package uml2kmt_visitors;

require kermeta
require "../visitableUML.kmt"
require "KmBuilder.kmt"

using kermeta::standard
using kermeta::interpreter
using kermeta::language::structure
using km_builder 

class Pass3_Uml2KMTVisitor inherits uml::visitors::TopDownVisitor
{
    reference output : kermeta::utils::Hashtable<uml::Element, Object>
    
    operation initialize(outputKm : kermeta::utils::Hashtable<uml::Element, Object>) is do
    	output := outputKm
    end
    
    // each UML2 operation needs its body to be parsed
    method visitOperation(visitable : uml::Operation) is do
    	// completes the operation
    	var op : Operation
    	op ?= output.getValue(visitable)
    	
    	// the dynamic expression for parsing
    	var de : DynamicExpression init DynamicExpression.new
    	de.initializeDefaults
		
    	// all other parameters
		op.ownedParameter.each{e |
			de.formalParameters.put(e.name, e.type)
		}
		
		op.tag.each{ t |
			if t.name == "km_body" then
				//FIXME : some work to do with code parsing of DynamicExpression
//				de.parse(t.~value)
				// we don't need the tag now
				op.tag.remove(t)
			end
		}
		
		op.body := de.expression
    	
    	super(visitable)
    end
}