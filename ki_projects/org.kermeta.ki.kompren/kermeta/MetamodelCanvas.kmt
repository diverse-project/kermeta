/*
 * Creation : November 16, 2010
 * Licence  : EPL 
 * Copyright: INRIA Rennes, Triskell
 * Authors  : Arnaud Blouin
 */
package kermeta::ki::kompren;

require "platform:/resource/org.kermeta.ki.kompren/kermeta/ModelExtension.kmt"
require "platform:/resource/org.kermeta.ki.kompren/kermeta/instrument/InstrumentsSelector.kmt"
require "platform:/resource/org.kermeta.ki.kompren/kermeta/instrument/InstrumentsCustomiser.kmt"
require "platform:/resource/org.kermeta.ki.kompren/kermeta/instrument/ElementsDisplayer.kmt"
require "platform:/resource/org.kermeta.ki.kompren/kermeta/instrument/Searcher.kmt"
require "platform:/resource/org.kermeta.ki.kompren/kermeta/action/Prune.kmt"
require "platform:/resource/org.kermeta.ki.kompren/kermeta/instrument/ZoomerMetamodel.kmt"
require "platform:/resource/org.kermeta.ki.malai/kermeta/instrument/UndoRedoManager.kmt"
require "platform:/resource/org.kermeta.ki.malai/kermeta/instrument/Scroller.kmt"
require "platform:/resource/org.kermeta.ki.kompren/kermeta/instrument/Pruner.kmt"
require "platform:/resource/org.kermeta.ki.kompren/kermeta/instrument/Hand.kmt"
require "platform:/resource/org.kermeta.ki.kompren/kermeta/instrument/Hierarcher.kmt"
require "platform:/resource/org.kermeta.ki.kompren/kermeta/Metamodel2ViewVisitor.kmt"

using kermeta::ki::malai::undo
using kermeta::ki::malai::widget
using kermeta::ki::malai::action
using kermeta::standard
using kermeta::ki::malai::interaction::event
using kermeta::ki::malai::instrument
using kermeta::persistence
using kermeta::language::structure
using kermeta::language::behavior
using kermeta::ki::malai::picking


class MetamodelCanvas inherits ActionHandler, UndoHandler {
	attribute metamodel : ModelingUnit
	
	attribute eltDisplayer : ElementsDisplayer
	
	attribute pruner : Pruner
	
	attribute hand : Hand
	
	attribute hierarcher : Hierarcher
	
	attribute flattener : Flattener
	
	attribute undoManager : UndoRedoManager
	
	attribute undoCollector : UndoCollector
	
	attribute selector : InstrumentsSelector
	
	attribute customiser : InstrumentsCustomiser
	
	attribute searcher : Searcher
	
	attribute zoomer : ZoomerMetamodel
	
	attribute scroller : Scroller
	
	attribute actionRegistry : ActionRegistry
	
	attribute toolbar : Panel
	
	attribute viewPanel : Panel
	


	
	operation initialise(pathFile : String) : Void is do
		loadMetamodel(pathFile)
		
		undoCollector     := UndoCollector.new 
		actionRegistry    := ActionRegistry.new
		
		undoCollector.initialise
		undoCollector.handlers.add(self)
		actionRegistry.initialise(undoCollector)
		actionRegistry.handlers.add(self)

		eltDisplayer	 := ElementsDisplayer.new
		hand			 := Hand.new
		hierarcher		 := Hierarcher.new
		zoomer			 := ZoomerMetamodel.new
		pruner      	 := Pruner.new
		flattener      	 := Flattener.new
		undoManager 	 := UndoRedoManager.new
		selector         := InstrumentsSelector.new
		customiser		 := InstrumentsCustomiser.new
		scroller         := Scroller.new
		searcher		 := Searcher.new
		
		eltDisplayer.initialise(actionRegistry)
		hand.initialise(actionRegistry)
		hierarcher.initialise(actionRegistry)
		zoomer.initialise(actionRegistry)
		flattener.initialise(actionRegistry)
		scroller.initialise(actionRegistry)
		customiser.pruner := pruner
		customiser.initialise(actionRegistry)
		pruner.initialise(actionRegistry)
		undoManager.initialise(actionRegistry)
		searcher.initialise(actionRegistry)
		
		pruner.metamodel := metamodel
		pruner.initialiseLinks()
		flattener.metamodel := metamodel
		flattener.initialiseLinks()
		hand.initialiseLinks()
		hierarcher.metamodel := metamodel
		hierarcher.zoomer := zoomer
		hierarcher.initialiseLinks()
		searcher.initialiseWidgets()
		searcher.initialiseLinks()
		searcher.metamodel := metamodel
		
		eltDisplayer.metamodel := metamodel
		eltDisplayer.initialise(actionRegistry)
		selector.initialise(actionRegistry)
		selector.initialiseInstruments(pruner, flattener, hierarcher, hand)

		var eventManager : EventManager init EventManager.new
		eventManager.initialise()
		
		initialiseUI
		extern org::kermeta::ki::kompren::KomprenFrameExtern.initialise(self, metamodel, toolbar, viewPanel, selector.handButton)

		metamodel.setEventManager(eventManager)
		var model2view : Metamodel2ViewVisitor init Metamodel2ViewVisitor.new
		model2view.modelingUnit := metamodel
		metamodel.accept(model2view)
		metamodel.update()
		
		eltDisplayer.initialiseLinks()
		eltDisplayer.interimFeedback
		eltDisplayer.setIsActivated(true)
		zoomer.zoomable  := metamodel
		zoomer.metamodel := metamodel
		zoomer.initialiseLinks()
		zoomer.setIsActivated(true)
		scroller.panel  := viewPanel
		scroller.initialiseLinks()
		scroller.setIsActivated(true)
		customiser.picker := toolbar
		customiser.initialiseLinks()
		customiser.setIsActivated(true)	
		selector.initialiseLinks()
		selector.setIsActivated(true)
		pruner.metamodel := metamodel
		undoManager.undoCollector := undoCollector		
		undoCollector.handlers.add(undoManager)
		undoManager.initialiseLinks()
		undoManager.setIsActivated(true)
		searcher.setIsActivated(true)
		
		pruner.addEventable(metamodel)
		flattener.addEventable(metamodel)
		hand.addEventable(metamodel)
		hierarcher.addEventable(metamodel)
		eltDisplayer.addEventable(toolbar)
		selector.addEventable(toolbar)
		undoManager.addEventable(toolbar)
		customiser.addEventable(toolbar)
		zoomer.addEventable(metamodel)
		zoomer.addEventable(toolbar)
		scroller.addEventable(metamodel)
		scroller.addEventable(toolbar)
		searcher.addEventable(toolbar)
	end
	
	
	
	method updateUndo() : Void is do
		refreshView
	end
	
	
	
	operation initialiseUI() : Void is do
		toolbar    := Panel.new
		viewPanel  := Panel.new
		
		toolbar.initialiseEventManager(true)
		viewPanel.initialiseEventManager(false)

		extern org::kermeta::ki::kompren::KomprenFrameExtern.initialiseToolbar(toolbar, undoManager.undoButton, 
					undoManager.redoButton, selector.prunerButton, selector.flattenerButton, selector.hierarcherButton,
					selector.handButton, pruner.grayedButton, pruner.hideButton, pruner.radiusSpinner, pruner.cardCheckBox,
					eltDisplayer.opButton, eltDisplayer.attrButton, searcher.textField)
					
		toolbar.addComponent(undoManager.undoButton, false)
		toolbar.addComponent(undoManager.redoButton, false)
		toolbar.addComponent(pruner.hideButton, false)
		toolbar.addComponent(pruner.grayedButton, false)
		toolbar.addComponent(pruner.radiusSpinner, false)
		toolbar.addComponent(pruner.cardCheckBox, false)
		toolbar.addComponent(selector.prunerButton, false)
		toolbar.addComponent(selector.hierarcherButton, false)
		toolbar.addComponent(selector.flattenerButton, false)
		toolbar.addComponent(selector.handButton, false)
		toolbar.addComponent(eltDisplayer.attrButton, false)
		toolbar.addComponent(eltDisplayer.opButton, false)
		toolbar.addComponent(searcher.textField, false)
	end



	operation loadMetamodel(muURI: String) : Void is do
		var rep : EMFRepository init EMFRepository.new
		var res : EMFResource
		res ?= rep.getResource(muURI)
		res.load()
		metamodel ?= res.one
	end

	
	
	operation setVisible(visible : Boolean) : Void is do
		extern org::kermeta::ki::kompren::KomprenFrameExtern.setVisible(self, visible)
	end
	
	
	operation refreshView() : Void is do
		extern org::kermeta::ki::kompren::KomprenFrameExtern.refreshView(self)
	end
	
	
	
	method onActionAdded(action : Action) : Void is do
		refreshView
	end
	
	method onActionAborted(action : Action) : Void is do
		refreshView
	end 
	
	method onActionCancelled(action : Action) : Void is do
		refreshView
	end 
	
	method onActionExecuted(action : Action) : Void is do
		refreshView
	end 
}
